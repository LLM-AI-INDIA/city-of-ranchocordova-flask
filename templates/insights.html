<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>FTB - Enterprise Q&A</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}"
        />

        <style>
            body {
                background-color: #f5f7fa;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                margin: 0;
                padding: 0;
            }

            .main-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                width: 90%;
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px 15px;
            }

            .chat-container {
                flex: 1;
                background-color: #ffffff;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                height: 80vh;
                border: 1px solid #e9ecef;
            }

            .chat-header {
                background: linear-gradient(90deg, #2563eb 0%, #6d28d9 100%);
                color: white;
                padding: 25px;
                text-align: center;
                flex-shrink: 0;
            }

            .chat-header h4 {
                margin: 0;
                font-weight: 300;
                font-size: 1.5rem;
            }

            .chat-body {
                display: flex;
                flex: 1;
                overflow: hidden;
                min-height: 0;
            }

            .chat-section {
                flex: 2;
                display: flex;
                flex-direction: column;
                min-width: 0;
            }

            .visualization-section {
                flex: 1;
                border-left: 1px solid #e9ecef;
                background-color: #fafbfc;
                display: none;
                flex-direction: column;
                min-width: 350px;
                max-width: 500px;
            }

            .visualization-section.show {
                display: flex;
            }

            .visualization-header {
                padding: 15px 20px;
                background-color: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }

            .viz-tab-content.active {
                display: block;
                height: 700px;
            }

            .visualization-content {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                max-height: calc(75vh - 60px);
            }

            .chart-container {
                position: relative;
                width: 100%;
                height: 350px;
                margin-bottom: 25px;
                border: 1px solid #e9ecef;
                border-radius: 10px;
                padding: 10px;
                background: white;
            }

            .chart-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: #333;
                margin-bottom: 15px;
                text-align: center;
            }

            .close-viz-btn {
                background: none;
                border: none;
                color: #666;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 5px;
                border-radius: 3px;
            }

            .close-viz-btn:hover {
                background-color: #e9ecef;
            }

            .chat-window {
                flex: 1;
                overflow-y: auto;
                padding: 25px 35px;
                background: #ffffff;
                min-height: 0;
                max-height: calc(80vh - 220px);
                scroll-behavior: smooth;
            }

            .message {
                margin-bottom: 20px;
                display: flex;
                align-items: flex-start;
                gap: 15px;
            }

            .user-message {
                flex-direction: row-reverse;
            }

            .bot-message {
                flex-direction: row;
            }

            .message-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                flex-shrink: 0;
            }

            .user-avatar {
                background-color: #4ab579;
                color: white;
            }

            .bot-avatar {
                background-color: #324ebb;
                color: #fff;
            }

            .message-content {
                max-width: 85%;
                padding: 18px 22px;
                border-radius: 18px;
                word-wrap: break-word;
                font-size: 15px;
                line-height: 1.6;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            }

            .user-message .message-content {
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #e9ecef;
                border-bottom-left-radius: 5px;
            }

            .bot-message .message-content {
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #e9ecef;
                border-bottom-left-radius: 5px;
            }

            .chat-input {
                padding: 25px 35px;
                background-color: #ffffff;
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                flex-shrink: 0;
            }

            .input-container {
                background: white;
                border-radius: 25px;
                padding: 8px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                border: 1px solid #e9ecef;
                display: flex;
                align-items: center;
                width: 100%;
            }

            #prompt {
                border: none;
                outline: none;
                flex: 1;
                padding: 12px 20px;
                font-size: 16px;
                background: transparent;
            }

            .send-btn {
                background: linear-gradient(90deg, #2563eb 0%, #6d28d9 100%);
                border: none;
                color: white;
                padding: 12px 20px;
                border-radius: 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 500;
            }

            .welcome-message {
                background: #eef0f0;
                padding: 15px;
                border-radius: 15px;
                margin-bottom: 20px;
                color: #555;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .input-loading {
                display: none;
                text-align: center;
                margin-bottom: 15px;
                padding: 12px;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 15px;
            }

            .loading-text {
                font-size: 14px;
                font-weight: 500;
                background: linear-gradient(
                    -45deg,
                    #667eea,
                    #764ba2,
                    #f093fb,
                    #f5576c,
                    #4facfe,
                    #43e97b
                );
                background-size: 400% 400%;
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: colorShift 2s ease-in-out infinite;
            }

            @keyframes colorShift {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }

            @supports not (-webkit-background-clip: text) {
                .loading-text {
                    background: none;
                    -webkit-text-fill-color: initial;
                    color: #667eea;
                    animation: colorCycle 2s ease-in-out infinite;
                }

                @keyframes colorCycle {
                    0% {
                        color: #667eea;
                    }
                    16% {
                        color: #764ba2;
                    }
                    33% {
                        color: #f093fb;
                    }
                    50% {
                        color: #f5576c;
                    }
                    66% {
                        color: #4facfe;
                    }
                    83% {
                        color: #43e97b;
                    }
                    100% {
                        color: #667eea;
                    }
                }
            }

            .viz-toggle-btn {
                background-color: #28a745;
                border: none;
                color: white;
                padding: 6px 12px;
                border-radius: 12px;
                cursor: pointer;
                font-size: 11px;
                margin-left: 10px;
                margin-top: 8px;
                display: inline-block;
            }

            .viz-toggle-btn:hover {
                background-color: #218838;
            }

            .viz-tab-btn {
                background: none;
                border: none;
                padding: 10px 15px;
                cursor: pointer;
                font-weight: 500;
                color: #667eea;
                border-bottom: 2px solid transparent;
            }

            .viz-tab-btn.active {
                border-bottom: 2px solid #667eea;
            }

            .viz-tab-content {
                display: none;
            }

            .viz-tab-content.active {
                display: block;
            }
            .table td,
            .table th {
                border: 1px solid #dee2e6;
            }

            pre {
                background-color: #2b2b2b;
                color: #f8f8f2;
                padding: 15px;
                border-radius: 8px;
                overflow-x: auto;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .table-responsive {
                overflow-x: auto;
            }

            .table {
                width: 100%;
                margin-bottom: 1rem;
                color: #212529;
                vertical-align: top;
                border-color: #dee2e6;
            }

            .table-striped > tbody > tr:nth-of-type(odd) > * {
                background-color: rgba(0, 0, 0, 0.05);
            }

            .table-hover > tbody > tr:hover > * {
                background-color: rgba(0, 0, 0, 0.075);
            }

            /* ---------- navbar user badge ---------- */
            .user-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.45rem;
                cursor: pointer;
                user-select: none;
                margin-right: 30px;
            }
            .user-letter {
                width: 32px;
                height: 32px;
                background: #e7f5fd;
                color: #3b6fbb;
                border-radius: 6px;
                display: grid;
                place-content: center;
                font-weight: 600;
                border-color: black;
            }
            .user-badge i {
                transition: transform 0.2s;
            }
            .user-badge.show i {
                transform: rotate(180deg);
            }

            /* ---------- dropdown ---------- */
            .logout-popover {
                position: absolute;
                top: 105%;
                right: 0;
                background: #fff;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
                padding: 0.5rem 0.8rem;
                min-width: 140px;
                display: none;
                z-index: 1055;
            }
            .logout-popover a {
                color: #dc3545;
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            /* ---------- page title ---------- */
            .page-title {
                font-size: 2.3rem;
                font-weight: 700;
                letter-spacing: -0.5px;
                margin-bottom: 4rem;
            }
            .page-sub {
                font-size: 1.1rem;
                font-weight: 600;
                color: #6c757d;
                margin-bottom: 3rem;
            }

            /* ---------- "< Back" link ---------- */
            .back-link {
                position: absolute;
                top: 100%; /* sits right under the logo */
                left: 0;
                font-size: 0.9rem;
                color: #000 !important;
                text-decoration: none;
                margin-top: 4px;
                margin-left: 25px;
            }
            .back-link:hover {
                color: #3b6fbb !important;
            }
        </style>
    </head>
    <body>
        <!-- Navbar with white background for logo -->
        <nav
            class="navbar navbar-light bg-white shadow-sm sticky-top"
            style="height: 85px"
        >
            <div class="container-fluid h-100 align-items-center">
                <!-- logo only -->
                <div class="d-flex align-items-center">
                    <a href="{{ url_for('login') }}">
                        <img
                            src="{{ url_for('static', filename='llm.png') }}"
                            alt="Logo"
                            style="height: 55px"
                        />
                    </a>
                </div>

                <!-- Admin badge + dropdown -->
                <div class="position-relative">
                    <div class="user-badge" onclick="toggleLogout()">
                        <span class="text-dark fw-500">Admin</span>
                        <i class="fa fa-chevron-down small text-muted"></i>
                    </div>
                    <div class="logout-popover" id="logoutBox">
                        <a href="{{ url_for('logout') }}">
                            <i class="fa fa-door-open"></i><span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="main-container">
            <h2
                class="text-center"
                style="
                    font-size: 2.3rem;
                    font-weight: 700;
                    margin-top: 25px;
                    margin-bottom: 20px;
                    letter-spacing: -0.5px;
                "
            >
                MCP-Driven Data Management With Natural Language Agentic
                Approach
            </h2>

            <div class="chat-container">
                <div class="chat-header">
                    <h4 class="mb-0">MCP-Driven Data Management</h4>
                </div>

                <div class="chat-body">
                    <div class="chat-section">
                        <div class="chat-window" id="chat-window">
                            <div class="welcome-message align-items-center">
                                Welcome! I'm your Multimodal Conversational
                                Platform agent, here to help you manage and
                                analyze data using natural language
                            </div>

                            <div class="message bot-message">
                                <div class="message-avatar bot-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    Greetings! How can I help you today?
                                </div>
                            </div>
                        </div>

                        <div class="chat-input">
                            <div class="input-loading" id="input-loading">
                                <div class="loading-text">
                                    <b>Generating response from server...</b>
                                </div>
                            </div>

                            <form id="chat-form">
                                <div class="input-container">
                                    <input
                                        type="text"
                                        id="prompt"
                                        placeholder="How can I help you?"
                                    />
                                    <button type="submit" class="send-btn">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div
                        class="visualization-section"
                        id="visualization-section"
                    >
                        <div class="visualization-header">
                            <h5 class="mb-0">Data Visualization</h5>
                            <button
                                class="close-viz-btn"
                                onclick="closeVisualization()"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div
                            class="visualization-tabs d-flex justify-content-center border-bottom"
                        >
                            <button
                                class="viz-tab-btn active"
                                id="tab-viz"
                                onclick="showVizTab('viz-content-container', this)"
                            >
                                Visualization
                            </button>
                            <button
                                class="viz-tab-btn"
                                id="tab-code"
                                onclick="showVizTab('viz-code-container', this)"
                            >
                                Code
                            </button>
                        </div>
                        <div
                            class="visualization-content"
                            id="visualization-content-wrapper"
                        >
                            <div
                                id="viz-content-container"
                                class="viz-tab-content active"
                            >
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                                    <p>
                                        Charts will appear here when available
                                    </p>
                                </div>
                            </div>
                            <div
                                id="viz-code-container"
                                class="viz-tab-content"
                            >
                                <pre id="viz-code-display">
                            <code></code>
                        </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const form = document.getElementById("chat-form");
            const promptInput = document.getElementById("prompt");
            const chatWindow = document.getElementById("chat-window");
            const visualizationSection = document.getElementById(
                "visualization-section",
            );
            const visualizationContentWrapper = document.getElementById(
                "visualization-content-wrapper",
            );
            const vizCodeDisplay = document
                .getElementById("viz-code-display")
                .querySelector("code");

            window.addEventListener("load", () => promptInput.focus());

            function createChart(containerId, data, type = "auto", title = "") {
                console.log(`Creating chart in ${containerId}:`, data);
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }
                let canvas = container.querySelector("canvas");
                if (!canvas) {
                    canvas = document.createElement("canvas");
                    container.appendChild(canvas);
                }
                const ctx = canvas.getContext("2d");
                const colors = [
                    "#667eea",
                    "#764ba2",
                    "#f093fb",
                    "#f5576c",
                    "#4facfe",
                    "#43e97b",
                    "#ff9a9e",
                    "#a8edea",
                ];
                if (type === "auto") {
                    const values = Object.values(data);
                    type = values.length <= 5 ? "doughnut" : "bar";
                }
                new Chart(ctx, {
                    type: type,
                    data: {
                        labels: Object.keys(data),
                        datasets: [
                            {
                                label: title || "Data",
                                data: Object.values(data),
                                backgroundColor:
                                    type === "doughnut"
                                        ? colors
                                        : colors.map((c) => c + "80"),
                                borderColor: colors,
                                borderWidth: 2,
                                borderRadius: type === "bar" ? 8 : 0,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: type === "doughnut",
                                position: "bottom",
                            },
                        },
                        scales:
                            type === "doughnut"
                                ? {}
                                : {
                                      y: {
                                          beginAtZero: true,
                                          grid: { color: "rgba(0,0,0,0.1)" },
                                      },
                                      x: { grid: { display: false } },
                                  },
                    },
                });
                console.log(`Chart ${type} created successfully`);
            }

            function showVisualization(data) {
                console.log("showVisualization called with:", data);
                if (!data) {
                    console.log("No data provided to showVisualization");
                    return;
                }
                visualizationContentWrapper.innerHTML = "";
                let chartsCreated = 0;
                Object.keys(data).forEach((key, index) => {
                    if (
                        typeof data[key] === "object" &&
                        data[key] !== null &&
                        Object.keys(data[key]).length > 0
                    ) {
                        const title = key
                            .replace(/([A-Z])/g, " $1")
                            .replace(/^./, (str) => str.toUpperCase());
                        const chartId = `chart_${index}`;
                        const div = document.createElement("div");
                        div.innerHTML = `<div class="chart-container" id="${chartId}"><div class="chart-title">${title}</div></div>`;
                        visualizationContentWrapper.appendChild(div);
                        createChart(chartId, data[key], "auto", title);
                        chartsCreated++;
                    }
                });
                if (chartsCreated > 0) {
                    visualizationSection.classList.add("show");
                    console.log(`Successfully created ${chartsCreated} charts`);
                } else {
                    console.log("No valid chart data found");
                }
            }

            function showVizTab(tabId, element) {
                document
                    .querySelectorAll(".viz-tab-content")
                    .forEach((tab) => tab.classList.remove("active"));
                document
                    .querySelectorAll(".viz-tab-btn")
                    .forEach((btn) => btn.classList.remove("active"));
                if (element) {
                    element.classList.add("active");
                }
                document.getElementById(tabId).classList.add("active");

                if (tabId === "viz-content-container") {
                    renderVisualization();
                } else if (tabId === "viz-code-container") {
                    renderCode();
                }
            }

            function renderVisualization() {
                if (
                    window.currentVisualizationData &&
                    typeof window.currentVisualizationData === "string"
                ) {
                    const vizContainer = document.getElementById(
                        "viz-content-container",
                    );
                    vizContainer.innerHTML = "";
                    const iframe = document.createElement("iframe");
                    iframe.style.width = "100%";
                    iframe.style.height = "100%";
                    iframe.style.border = "none";
                    iframe.srcdoc = window.currentVisualizationData;
                    vizContainer.appendChild(iframe);
                    console.log(
                        "Successfully rendered visualization in iframe.",
                    );
                } else {
                    const vizContainer = document.getElementById(
                        "viz-content-container",
                    );
                    vizContainer.innerHTML =
                        '<div class="text-center text-muted"><i class="fas fa-chart-line fa-3x mb-3"></i><p>Charts will appear here when available</p></div>';
                    console.error("No valid HTML visualization data found.");
                }
            }

            function renderCode() {
                if (
                    window.currentVisualizationData &&
                    typeof window.currentVisualizationData === "string"
                ) {
                    vizCodeDisplay.textContent =
                        window.currentVisualizationData;
                    console.log("Successfully displayed visualization code.");
                } else {
                    vizCodeDisplay.textContent =
                        "No visualization code to display.";
                }
            }

            function closeVisualization() {
                visualizationSection.classList.remove("show");
                document.getElementById("viz-content-container").innerHTML = "";
                document
                    .getElementById("viz-code-container")
                    .querySelector("pre code").textContent = "";
            }

            function formatResponse(text) {
                let cleaned = text
                    .replace(/---[\s\S]*?---/g, "")
                    .replace(/Iterative Analysis Complete[\s\S]*?\./g, "")
                    .replace(/Session total:[\s\S]*?\./g, "")
                    .replace(/Files accessed this query:[\s\S]*?\./g, "")
                    .trim();
                return cleaned.replace(/\n/g, "<br>");
            }

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const userMessage = promptInput.value.trim();
                if (!userMessage) return;

                const userDiv = document.createElement("div");
                userDiv.className = "message user-message";
                userDiv.innerHTML = `
            <div class="message-avatar user-avatar"><i class="fas fa-user"></i></div>
            <div class="message-content">${userMessage}</div>
        `;
                chatWindow.appendChild(userDiv);
                promptInput.value = "";
                scrollToBottom();

                document.getElementById("input-loading").style.display =
                    "block";

                try {
                    const response = await fetch("/insights_api", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ query: userMessage }),
                    });

                    const data = await response.json();
                    document.getElementById("input-loading").style.display =
                        "none";

                    const botDiv = document.createElement("div");
                    botDiv.className = "message bot-message";

                    let contentHtml = `<div class="message-content">`;

                    if (data.answer) {
                        contentHtml += `<div class="mb-2">${formatResponse(data.answer)}</div>`;
                    }

                    if (data.html_table) {
                        // The fix is here: we wrap the table in a div with Bootstrap classes
                        contentHtml += `<div class="mt-2 table-responsive">${data.html_table}</div>`;
                    }

                    if (data.has_visualization) {
                        contentHtml += `<div class="mt-2">
                                <button class="viz-tab-btn active" id="tab-viz" onclick="showVizTab('viz-content-container', this)">Visualization</button>
                                <button class="viz-tab-btn" id="tab-code" onclick="showVizTab('viz-code-container', this)">Code</button>
                            </div>`;
                    }
                    contentHtml += `</div>`;

                    botDiv.innerHTML = `
                <div class="message-avatar bot-avatar"><i class="fas fa-robot"></i></div>
                ${contentHtml}
            `;
                    chatWindow.appendChild(botDiv);

                    window.currentVisualizationData = data.visualization;

                    if (data.has_visualization && data.visualization) {
                        showVizTab(
                            "viz-content-container",
                            document.getElementById("tab-viz"),
                        );
                        visualizationSection.classList.add("show");
                    } else {
                        visualizationSection.classList.remove("show");
                    }

                    scrollToBottom();
                } catch (error) {
                    document.getElementById("input-loading").style.display =
                        "none";
                    console.error("Error:", error);
                    const errorDiv = document.createElement("div");
                    errorDiv.className = "message bot-message";
                    errorDiv.innerHTML = `
                <div class="message-avatar bot-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">Sorry, I encountered an error. Please try again.</div>
            `;
                    chatWindow.appendChild(errorDiv);
                    scrollToBottom();
                }
            });

            function scrollToBottom() {
                requestAnimationFrame(() => {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                });
            }

            function toggleLogout() {
                const box = document.getElementById("logoutBox");
                box.style.display =
                    box.style.display === "block" ? "none" : "block";
            }

            // optional: close the pop-over when clicking outside
            document.addEventListener("click", function (e) {
                const badge = document.querySelector(".user-badge");
                const box = document.getElementById("logoutBox");
                if (!badge.contains(e.target) && !box.contains(e.target)) {
                    box.style.display = "none";
                }
            });
        </script>
    </body>
</html>
